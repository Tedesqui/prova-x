<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Corre√ß√£o de Provas com Gemini</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <style>
    body, html {
      margin: 0; padding: 0; font-family: sans-serif;
      background: black; color: white; overflow: hidden;
    }
    video, canvas {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh; object-fit: cover; z-index: 0;
    }
    #output {
      position: fixed; bottom: 60px;
      width: 100%; background: rgba(0,0,0,0.8);
      padding: 10px; font-size: 16px; z-index: 2;
      max-height: 40vh; overflow-y: auto; box-sizing: border-box;
    }
    #controls {
      position: fixed; bottom: 10px; left: 50%;
      transform: translateX(-50%); z-index: 3;
      display: flex; gap: 10px;
    }
    button {
      font-size: 16px; padding: 10px 16px;
      background: #4285F4; border: none; /* Cor do Google */
      border-radius: 8px; color: white; cursor: pointer;
    }
    button:hover { background: #357ae8; }
    button:disabled { background: #555; cursor: not-allowed; }
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

<div id="controls">
  <!-- Bot√£o de Zoom Adicionado -->
  <button id="zoomBtn">üîç Zoom 1x</button>
  <button id="captureBtn">üì∑ Corrigir</button>
</div>

<div id="output">üì∑ Aponte a c√¢mara para a resposta da prova e toque em "Corrigir"</div>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const output = document.getElementById("output");
  const captureBtn = document.getElementById("captureBtn");
  const zoomBtn = document.getElementById("zoomBtn"); // Refer√™ncia para o bot√£o de zoom

  // Vari√°veis para controlar o zoom
  let mediaTrack;
  let currentZoom = 1;
  const zoomLevels = [1, 2, 3];
  let zoomCapabilities = null;

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } }
      });
      video.srcObject = stream;
      mediaTrack = stream.getVideoTracks()[0];
      
      // Verifica se o dispositivo suporta zoom
      if (mediaTrack.getCapabilities && mediaTrack.getCapabilities().zoom) {
        zoomCapabilities = mediaTrack.getCapabilities().zoom;
      } else {
        zoomBtn.disabled = true;
        zoomBtn.innerText = "Zoom N/A";
      }
    } catch (err) {
      output.innerText = "‚ùå Erro ao aceder √† c√¢mara. Verifique as permiss√µes.";
      zoomBtn.disabled = true;
    }
  }

  // Fun√ß√£o para alternar o zoom
  function toggleZoom() {
    if (!zoomCapabilities) return;

    // Encontra o √≠ndice do zoom atual e avan√ßa para o pr√≥ximo
    const currentIndex = zoomLevels.indexOf(currentZoom);
    currentZoom = zoomLevels[(currentIndex + 1) % zoomLevels.length];

    // Garante que o zoom n√£o exceda o m√°ximo permitido pelo dispositivo
    if (currentZoom > zoomCapabilities.max) {
      currentZoom = zoomLevels[0]; // Volta para 1x
    }

    mediaTrack.applyConstraints({ advanced: [{ zoom: currentZoom }] });
    zoomBtn.innerText = `üîç Zoom ${currentZoom}x`;
  }

  async function captureAndAnalyze() {
    captureBtn.disabled = true;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    output.innerText = "üß† A ler resposta com OCR...";

    try {
      const { data: { text } } = await Tesseract.recognize(canvas, 'por', {
        logger: m => {
          if (m.status === 'recognizing text') {
            output.innerText = `üß† A ler... (${Math.round(m.progress * 100)}%)`;
          }
        }
      });

      output.innerText = `üîé Texto detetado:\n"${text.trim()}"\n\nA enviar para o Gemini...`;

      // A chamada agora √© para o nosso backend do Gemini.
      const response = await fetch("/api/corrigir-gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto: text })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `Erro do servidor: ${response.status}`);
      }

      const data = await response.json();
      output.innerText = `‚úÖ Corre√ß√£o (Gemini):\n\n${data.resultado}`;

    } catch (err) {
      output.innerText = `‚ùå Erro: ${err.message}`;
    } finally {
      captureBtn.disabled = false;
    }
  }

  // Adiciona os listeners aos bot√µes
  captureBtn.addEventListener('click', captureAndAnalyze);
  zoomBtn.addEventListener('click', toggleZoom);
  
  startCamera();
</script>

</body>
</html>
